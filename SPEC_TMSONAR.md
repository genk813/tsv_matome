# SPEC.md — 検索機能 追記ドラフト

> ※本ドラフトは **HTML（全文検索画面・検索結果）由来の項目をそのまま列挙**。解釈・提案なし。

---

## 検索項目（プルダウン／入力欄）

* 商標（ID: 101）
* 称呼（表記同一）（ID: 103）
* 国際分類（類似群コード展開）（ID: 104）
* 法区分＋類（ID: 105）
* 類似群コード（ID: 106）
* 指定商品／役務（ID: 107）
* 拒絶条文コード（ID: 108）
* 審決分類（国内のみ）（ID: 109）
* ウィーンコード（ID: 112）
* 称呼（発音同一）（ID: 123）
* 最終処分（ID: 130）
* 出願人／権利者（ID: 102）
* 出願人／権利者住所（ID: 134）
* 国県コード（出願人）（ID: 129）
* 代理人（ID: 124）
* 出願日／国際登録日（事後指定日）（ID: 110）
* 登録日／国内登録日（ID: 111）
* 新規出願追加日（ID: 113）
* 存続期間満了日（国内のみ）（ID: 114）
* ステータス変更日（ID: 115）
* 最終処分日（ID: 116）
* 拒絶査定発送日（ID: 117）
* 分納満了日（国内のみ）（ID: 121）
* 登録公報発行日（国内のみ）（ID: 122）
* 新規登録追加日（ID: 142）
* 公開公報発行日（ID: 143）
* 出願番号／マドプロ管理番号（ID: 118）
* 登録番号／国際登録番号（ID: 119）
* 審判番号（国内のみ）（ID: 120）
* 出願番号／登録番号（ID: 141）
* 中間記録コード（ID: 131）
* 商標タイプ（ID: 125）
* 商標の詳細な説明（ID: 126）
* 出願種別（ID: 127）
* 付加情報（ID: 128）
* 商標文字数（ID: 132）
* 称呼音数（ID: 133）
* 情報提供数（ID: 135）
* 閲覧請求数（ID: 136）
* 区分数（ID: 137）
* 出願人／権利者数（ID: 138）
* 称呼数（ID: 139）

---

## ヘッダー条件（上部フィルタ）

* ラジオ①：全て／登録済／未登録
* ラジオ②：全て／国内／マドプロ
* チェック：権利存続／失効5年／失効10年／失効全て／出願却下を除く

---

## メモ

* 由来：`全文検索画面.txt`・`検索結果.txt`
* 反映方針：そのまま列挙（順不同／重複整理済み）

---

## 検索方法（項目別、TMSONAR準拠）

画面ヘルプ（全文検索画面.txt / 検索結果.txt の <div id="help-type-...">）に記載の方式のみを反映。?=全指定。スペース/カンマで複数指定可。

テキスト系

ID101 商標: 完全一致・部分一致（?指定）。記号や読点は保持。ローマ数字は算用で格納。複数語はスペース/カンマ。

ID102 出願人／権利者: 完全一致・部分一致（?）。名称正規化（ひら→カタ、英小→大、長音/横線/ハイフン統一、スペース除去、旧→新字体、「株式会社等」語の排除）。

ID107 指定商品／役務: 完全一致・部分一致（?）。語句正規化（特殊記号・句読点・中点・点・カンマ・クォートの排除、旧→新字体 など）。

ID134 出願人／権利者住所: 完全一致・部分一致（?）。県名欠落等は元データ依存。

ID103 称呼（表記同一）: 完全一致・部分一致（?）。半角カタカナのみ有効。

ID123 称呼（発音同一）: 完全一致・部分一致（?）。表記ゆれ規則（ヲ/ヂ/ヅ→オ/ジ/ズ など、長音・促音の同一視、例：ティーエル→テル）。

ID126 商標の詳細な説明: 入力可（テキスト）。

コード/分類系

ID106 類似群コード: 完全一致・前方一致（末尾?）。例：11?→先頭2桁が11の全コード。

ID104 国際分類（類似群コード展開）: 2桁類番号を指定→類似群コードに展開して検索。小売→商品クロス、備考類似の自動展開は非対応。

ID105 法区分＋類: 完全一致・部分一致（?）。[法区分(V,W,X,Y,Z,0-4)]+[類(2桁)] で指定。

ID112 ウィーンコード: 完全一致・前方一致。階層（大分類.中分類.小分類.細分類）。前方一致は下位省略可（例：1.3.20→1.3.20.01等含む）。

ID109 審決分類（国内のみ）: 形式 審判種別-判示コード-結論コード。全指定?。各コードは完全一致・前方一致（末尾?）。補助ボタン選択可。

ID108 拒絶条文コード: 完全一致・前方一致（末尾?）。マドプロは国内コードへ統一。補助ボタン選択可。

ID131 中間記録コード: 全指定?。補助画面 or 直接入力。国内/マドプロタブで選択（複数タブ併用可）。

ID125 商標タイプ: 数値指定。全指定?。補助ボタン選択可。（例：01=標準文字, 02=図形, 03=立体, 04=ホログラム, 05=色彩のみ, 06=位置）

ID127 出願種別: 全指定?。補助ボタン or 直接入力（例：01通常, 02分割, 03変更, 04優先, 08団体, 09地域団体 等）。

ID128 付加情報: 全指定?。補助ボタン or 直接入力（例：05標準文字, 04 3条2項 等）。

ID129 国県コード（出願人）: 全指定?。補助画面 or 直接入力。マドプロは本国官庁コードを使用。

ID124 代理人: 国内代理人を対象。社名要素（株式会社等）の排除は行わない旨の注意あり。

日付/番号・レンジ系

ID110 出願日／国際登録日（事後指定日）: 完全一致・範囲指定（開始:終了）。全指定?。西暦/和暦OK。区切り / - . 可。前省略=:YYYYMMDD（以前）、後省略=YYYYMMDD:（以降）。

ID111 登録日／国内登録日: 同上（完全一致・範囲、?、西暦/和暦、区切り許容、前後省略可）。

ID114 存続期間満了日（国内のみ）: 同上（完全一致・範囲、?）。※分納後半5年納付で日付消滅の注記あり。

ID121 分納満了日（国内のみ）: 同上（完全一致・範囲、?）。

ID122 登録公報発行日（国内のみ）: 同上（完全一致・範囲、?）。マドプロは発行日未提供のため対象外。

ID143 公開公報発行日: 完全一致・範囲。西暦/和暦、区切り許容。発行後検索可能までの遅延に関する注記あり。

ID113 新規出願追加日: DB反映日。範囲はコロン:。G0,G1... 等の世代指定も可。

ID142 新規登録追加日: 同上（DB反映日、範囲は:、世代指定可）。

ID118 出願番号／マドプロ管理番号: 完全一致・範囲（開始:終了）。西暦/和暦OK。例：2004-000001:2004-123456 / H16-000001:H18-123456。

ID119 登録番号／国際登録番号: 完全一致・範囲（開始:終了）。例：1234560:1234567。

ID120 審判番号（国内のみ）: 完全一致・範囲（開始:終了）。

ID141 出願番号／登録番号: 完全一致のみ（範囲不可）。年と番号の区切り-等。国際登録番号は国1234560形式も可。

カウント系（数値レンジ）

ID132 商標文字数: 文字統一後の文字数。範囲はコロン:（例：1:5, 1:, :5）。

ID133 称呼音数: 拗音・長音・促音は各1音。範囲はコロン:。

ID135 情報提供数: 範囲はコロン:。国内/マドプロ対象。

ID136 閲覧請求数: 範囲はコロン:。国内のみ。

ID137 区分数: 範囲はコロン:。

ID138 出願人／権利者数: 範囲はコロン:。

ID139 称呼数: 範囲はコロン:。

注記：AND/OR の論理結合UIは画面上に存在するが、HTMLヘルプでは正規表現や後方一致の記載は確認できず、前方一致は主に ? サフィックス、範囲は : で指定する仕様。


## 実装状況

| SPEC ID | 項目            | 実装状況      | コード上の対応/根拠                                                    | 備考                                     |
| ------- | ------------- | --------- | ------------------------------------------------------------- | -------------------------------------- |
| 101     | 商標            | ✅ 実装      | `SearchType.TRADEMARK` → `search_trademark_name()`（FTS5/LIKE） | 複数語OR等の細かい挙動はUI側仕様。                    |
| 102     | 出願人／権利者       | ✅ 実装      | `SearchType.APPLICANT` → `search_applicant()`                 | 住所・国県コードは別ID。                          |
| 103     | 称呼（表記同一）      | ✅ 実装      | `SearchType.PHONETIC` → `search_phonetic()`                   | `PHONETIC`で表記同一／発音同一を兼ねている可能性あり（関数一本）。 |
| 123     | 称呼（発音同一）      | ✅ 実装（一本化） | 同上                                                            | 表記同一/発音同一の切替UIはコード外。                   |
| 106     | 類似群コード        | ✅ 実装      | `SearchType.SIMILAR_GROUP` → `search_by_similar_group()`      | 前方一致`?`相当の実装は関数内ロジック依存。                |
| 104     | 国際分類（類展開）     | ✅ 実装      | `search_by_international_class()`（今回追加）                        | 類番号→類似群コード展開実装済み。                     |
| 105     | 法区分＋類         | ✅ 実装      | `SearchType.LAW_CLASS` → `search_by_law_class()`              | 法区分は数値(4)で格納。Y/W/X等への変換要。               |
| 107     | 指定商品／役務       | ✅ 実装      | `SearchType.GOODS_SERVICES` → `search_goods_services()`       | AND/ORの扱いは実装に`item_and`等の痕跡あり。         |
| 108     | 拒絶条文コード       | ✅ 実装      | `SearchType.REJECTION_CODE` → `search_by_rejection_code()`   | データ待ち。枠組み実装済み。                     |
| 109     | 審決分類          | ✅ 実装      | `SearchType.DECISION_CLASS` → `search_by_decision_class()`     | 審判種別-判示-結論の形式で検索。                   |
| 112     | ウィーンコード       | ✅ 実装      | `SearchType.VIENNA_CODE` → `search_by_vienna_code()`          | CTEで重複除去。階層的前方一致対応。                    |
| 130     | 最終処分          | ✅ 実装      | `search_by_final_disposition()`（今回完全実装）                     | 補助ボタンコード定義含む完全実装。                    |
| 110     | 出願日           | ✅ 実装      | `SearchType.DATE_RANGE` + `date_type_map['1']='app_date'`     | 範囲検索OK。                                |
| 111     | 登録日           | ✅ 実装      | `date_type_map['2']='reg_date'`                               | 同上。                                    |
| 122     | 登録公報発行日       | ✅ 実装      | `date_type_map['4']='reg_article_gazette_date'`               | date_type_mapに追加済み。                    |
| 143     | 公開公報発行日       | ✅ 実装      | `date_type_map['3']='pub_article_gazette_date'`               | OK。                                    |
| 113     | 新規出願追加日       | ❌ 未実装     | 対応フィールド未確認                                                    | DB反映日/世代指定は未対応。                        |
| 142     | 新規登録追加日       | ❌ 未実装     | 同上                                                            | 同上。                                    |
| 114     | 存続期間満了日       | ✅ 実装      | `SearchType.EXPIRY_DATE` → `search_by_expiry_date()`          | 管理情報テーブルから日付範囲検索。                    |
| 115     | ステータス変更日      | ⚠️ 部分     | 進捗情報にデータ存在（process_date）                                      | 専用検索未実装だがデータ存在。                       |
| 116     | 最終処分日         | ✅ 実装      | `SearchType.DECISION_DATE` → `search_by_decision_date()`      | 管理情報テーブルから日付範囲検索。                    |
| 117     | 拒絶査定発送日       | ⚠️ 部分     | draft_recordsで推定可能（intermediate_code='A131'）                  | 専用検索未実装だがデータ存在。                       |
| 121     | 分納満了日         | ✅ 実装      | `SearchType.PAYMENT_DATE` → `search_by_payment_date()`        | 管理情報テーブルから日付範囲検索。                    |
| 118     | 出願番号／マドプロ管理番号 | ✅ 実装      | `SearchType.APP_NUM` → `search_by_app_num()`                  | 範囲/和暦は実装次第、少なくとも完全一致はOK。               |
| 119     | 登録番号／国際登録番号   | ✅ 実装      | `SearchType.REG_NUM` → `search_by_reg_num()`                  | 同上。                                    |
| 120     | 審判番号          | ✅ 実装      | `SearchType.APPEAL_NUM` → `search_by_appeal_num()`            | 完全一致・範囲検索対応。                          |
| 141     | 出願番号／登録番号（複合） | ❌ 未実装     | 複合キー検索なし                                                      | 追加要。                                   |
| 131     | 中間記録コード       | ✅ 実装      | `SearchType.INTERMEDIATE_CODE` → `search_by_intermediate_code()` | データ待ち。枠組み実装済み。                     |
| 125     | 商標タイプ         | ✅ 実装      | `SearchType.TRADEMARK_TYPE` → `search_by_trademark_type()`    | TMSONAR仕様の10分類に対応（データ待ち）。               |
| 126     | 詳細な説明         | ✅ 実装      | `SearchType.DETAILED_DESC` → `search_detailed_description()`  | 部分一致検索対応。                              |
| 127     | 出願種別          | ✅ 実装      | `SearchType.APP_TYPE` → `search_by_app_type()`                | app_type1〜5のOR検索。複数指定可。                |
| 128     | 付加情報          | ✅ 実装      | `SearchType.ADDITIONAL_INFO` → `search_by_additional_info()`  | orig_app_typeで検索実装済み。                  |
| 134     | 出願人/権利者住所    | ✅ 実装      | `SearchType.APPLICANT_ADDRESS` → `search_by_applicant_address()` | 部分一致検索実装済み。                        |
| 129     | 国県コード（出願人）    | ✅ 実装      | `SearchType.COUNTRY_CODE` → `search_by_country_code()`        | 都道府県コード検索実装済み。                      |
| 132     | 商標文字数         | ✅ 実装      | `SearchType.TRADEMARK_LENGTH` → `search_by_trademark_length()` | 範囲検索実装済み。                           |
| 133     | 称呼音数          | ✅ 実装      | `SearchType.PHONETIC_LENGTH` → `search_by_phonetic_length()` | 範囲検索実装済み。                           |
| 135     | 情報提供数         | ✅ 実装      | `SearchType.INFO_PROVISION_COUNT` → `search_by_info_provision_count()` | 刊行物等提出書(A50,A417)のカウント実装済み。 |
| 136     | 閲覧請求数         | ✅ 実装      | `SearchType.BROWSING_REQUEST_COUNT` → `search_by_browsing_request_count()` | 閲覧請求書(A405)のカウント実装済み。 |
| 137     | 区分数           | ✅ 実装      | `SearchType.CLASS_COUNT` → `search_by_class_count()`          | 範囲検索実装済み。                              |
| 138     | 出願人／権利者数      | ✅ 実装      | `SearchType.APPLICANT_COUNT` → `search_by_applicant_count()`  | 出願人数集計＋範囲検索実装済み。                      |
| 139     | 称呼数           | ✅ 実装      | `SearchType.PHONETIC_COUNT` → `search_by_phonetic_count()`    | 称呼数集計＋範囲検索実装済み。                       |

---

## 検索結果表示項目（2025-08-10追記）

### 現在の表示項目（basic_info）
検索結果として以下の情報が表示されます：

| 項目名 | DBカラム | 表示形式 | 備考 |
|--------|----------|----------|------|
| 出願番号 | app_num | 単一値 | 必須 |
| 登録番号 | reg_num | 単一値 | Nullの場合"None"表示 |
| 商標名 | trademark_name | 単一値 | 検索・表示用の商標名 |
| 称呼 | phonetics | カンマ区切りリスト | 複数の称呼を表示 |
| 出願日 | app_date | YYYYMMDD | |
| 登録日 | reg_date | YYYYMMDD | Nullの場合"None"表示 |
| 区分 | classes | カンマ区切りリスト | 複数区分対応 |
| 商品・役務 | goods_services | 区分ごとの辞書 | 全文表示 |
| 類似群コード | similar_groups | 区分ごとの辞書 | 5文字区切りカンマ区切り |
| 出願人 | applicants | リスト | 現在空（データ未投入） |
| 代理人 | agents | リスト | 現在空（データ未投入） |
| 権利者 | right_holders | リスト | 現在空（データ未投入） |
| 最終処分コード | final_disposition_code | 単一値 | 現在N/A |
| 最終処分日 | final_disposition_date | YYYYMMDD | 現在N/A |

### 将来の拡張表示項目
DBに存在し、将来的に表示可能な追加項目：

- **事件情報**: 出願種別、標準文字/立体/色彩商標フラグ、担当官コード、区分数、国際登録番号等
- **ウィーン分類**: 図形商標の分類コードと説明
- **優先権情報**: 優先権国、番号、日付
- **経過情報**: 経過日付、内容、詳細
- **審判情報**: 審判番号、種別、請求日、決定日、結果
- **管理情報**: 権利期限日、次回更新期限、権利状態

### 表示カスタマイズ構想
将来的にユーザーが表示項目を選択できる機能を実装予定：
- 表示レベル設定（minimal/basic/detailed）
- カスタム表示項目選択
- 表示プロファイル保存
- 出力フォーマット選択（table/json/csv/report）
