# TMCloud Development History

## 2025-08-24 商標検索システムの修正と改善

### 実施した修正

#### 1. 商標画像表示の修正
**問題**: 立体商標（3D商標）で複数の画像（6枚）が存在する場合、全ての画像データが結合されて破損した画像として表示される
- 例: 出願番号2025054756の立体商標

**解決策**:
- `page_num`フィールドを使用して最初のページのみを取得するようにSQLクエリを修正
- 複数ページの画像がある場合は`MIN(page_num)`で最初のページのみ選択

#### 2. ウィーンコード表示の修正
**問題**: ウィーンコードの末尾が`.00`の場合も表示されていた（例: 18.05.10.00）
- TMSONARでは末尾の`.00`は省略される仕様

**解決策**:
- CASE文を使用して末尾の`.00`を自動的に除去
- 18.05.10.00 → 18.05.10 のように正しく表示

#### 3. ワイルドカード検索の全面的な修正
**問題**: 
- 「ブル？」で前方一致検索したら「らくらくアルミユニットケーブル」がヒット
- ワイルドカードなしの「ブル」が部分一致になっていた

**解決策**:
- ワイルドカードパターンの完全な再実装
  - `xxx` → 完全一致
  - `xxx？` → 前方一致
  - `？xxx` → 後方一致
  - `？xxx？` → 部分一致
- 全ての検索関数（商標名、称呼、商品・役務、出願人、詳細な説明）に適用

#### 4. Web UIの改善
**実装内容**:
1. **デフォルト検索条件の追加**
   - ページロード時に3つの検索条件を自動表示
   - 1番目: 商標名
   - 2番目: 称呼（表記同一）
   - 3番目: 区分

2. **並び替え機能の修正**
   - 問題: 一度並び替えると、その後の並び替えが効かない
   - 解決: 
     - `originalSearchResults`で元データを保持
     - `updateResultsDOM()`関数を新規作成
     - 並び替え時は常に元データから処理

### 技術的な詳細

#### SQLiteの制限事項への対応
- GROUP_CONCATのデフォルト制限（1MB）により画像データが切れる問題
- 解決: 複数画像の場合は最初の1枚のみ取得

#### パフォーマンス最適化
- 画像クエリに適切なインデックスヒントを追加
- ワイルドカード検索でFTS（全文検索）とLIKE検索を適切に使い分け

### ファイル変更一覧
1. `tmcloud_search_integrated.py` - メイン検索実装
2. `tmcloud_search_optimized.py` - 最適化版検索
3. `tmcloud_search_simple.py` - シンプル版検索
4. `tmcloud_simple_web.py` - Webインターフェース

### テスト結果
- 商標名検索: ✅ 完全一致/ワイルドカード動作確認
- 称呼検索: ✅ 完全一致/ワイルドカード動作確認
- 画像表示: ✅ 複数画像の商標も正しく表示
- ウィーンコード: ✅ 末尾.00の自動除去確認
- 並び替え: ✅ 複数回の並び替え動作確認

### 今後の課題
- 検索パフォーマンスのさらなる最適化
- 複数画像の切り替え表示機能の実装
- より高度な検索オプションの追加