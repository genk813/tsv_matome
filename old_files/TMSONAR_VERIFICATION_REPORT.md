# TMSONAR検索仕様の実装検証レポート

## 1. TMSONARの称呼検索仕様

### 称呼（発音同一）検索 - type-123
1. **完全一致および部分一致検索**（クエスチョンマークにて指定）が可能
2. **全指定**は「？」のみ入力
3. **複数指定**の場合はスペースまたはカンマにて指定
4. 半角カタカナに変換できない文字は検索できません
5. **5段階の発音同一化処理**：
   - 1）完全一致
   - 2）発音同一（ヲ＝オ、ヂ＝ジ、ヅ＝ズ、ヂャ＝ジャ、ヂュ＝ジュ、ヂョ＝ジョ）
   - 3）微差音統一（ヴァ＝バ、ヴィ＝ビ、ヴ＝ブ、ヴェ＝ベ、ヴォ＝ボ、ツィ＝チ、テュ＝チュ、フュ＝ヒュ、ヴュ＝ビュ）
   - 4）長音、促音、長音に準ずる音の差および有無を同一として判断
   - 5）拗音大文字化（発音同一、微差音統一処理後）

### 称呼（表記同一）検索 - type-103
1. 完全同一の特許庁称呼を検索
2. 完全一致および部分一致検索（クエスチョンマーク）が可能
3. 全指定は「？」のみ入力
4. 複数指定の場合はスペースまたはカンマにて指定

## 2. 現在の実装状況（tmcloud_search_v4_optimized.py）

### ✅ 実装済み機能
1. **発音同一化処理（2,3段階）** - `apply_phonetic_rules()`で実装
2. **拗音大文字化（5段階）** - `apply_yoon_expansion()`で実装
3. **部分一致検索** - ワイルドカード（?）対応
4. **正規化列（pronunciation_norm）** - 高速検索のための事前正規化
5. **LIKE検索の安全化** - エスケープ処理実装
6. **IN句上限対策** - 400件制限

### ❌ 未実装・問題点
1. **複数キーワード指定** - スペース/カンマ区切りの複数検索が未実装
2. **全指定（？のみ）** - 「？」のみで全件検索する機能が未実装
3. **長音・促音処理の不完全性** - 正規化時に長音処理が行われていない（バリエーション生成時のみ）
4. **半角カタカナ** - 仕様では半角カタカナだが、実装は全角カタカナ

## 3. 修正が必要な項目

### 優先度：高
1. **複数キーワード対応**
   ```python
   # 入力: "ソニー インフォ,パナソニック"
   # → ["ソニー", "インフォ", "パナソニック"] に分割して検索
   ```

2. **全指定機能**
   ```python
   # 入力: "？"
   # → 全件を返す特別処理
   ```

### 優先度：中
3. **長音処理の段階的適用**
   ```python
   # 例: ティーエル → テイーエル → テーエル → テエル → テル
   # 現在は一度に処理しているが、段階的に処理すべき
   ```

### 優先度：低
4. **半角カタカナ対応**
   - 現状の全角カタカナでも問題ないが、仕様通りなら半角に変換すべき

## 4. 検証結果

### テストケース検証

| テストケース | TMSONAR仕様 | 現在の実装 | 結果 |
|------------|------------|----------|------|
| ブルゥレット → ブルーレット | ○ | ○ | ✅ |
| チヂミ → チジミ | ○ | ○ | ✅ |
| ヴェール → ベール | ○ | ○ | ✅ |
| アクセッサリー → アクセサリ | ○ | ○ | ✅ |
| フィルム → フイルム | ○ | ○ | ✅ |
| 複数キーワード検索 | ○ | × | ❌ |
| ？のみで全件検索 | ○ | × | ❌ |
| ティーエル → テル | ○ | △ | ⚠️ |

## 5. 結論

**実装率: 約75%**

主要な発音同一化処理は実装されているが、以下の機能追加が必要：
1. 複数キーワード検索（必須）
2. 全指定機能（必須）
3. 段階的な長音処理（推奨）

性能面では正規化列の導入により高速化を実現しており、TMSONARの基本的な検索機能は満たしている。