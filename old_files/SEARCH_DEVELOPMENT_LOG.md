# TMCloud 検索スクリプト開発記録

## 開発日時
2025-08-07

## 開発プロセス

### 1. 要件定義フェーズ

#### 基本要件
- **検索の主な用途**: 特定の商標案件の検索
- **参考システム**: TMSONAR
- **インターフェース**: CLI（対話形式） → 将来的にWeb
- **検索方式**: 完全一致（第1段階）
- **表示形式**: 表形式（簡潔）

#### 段階的実装計画
- **第1段階（基本検索）** ← 今回実装
  - 出願番号による検索
  - 商標名（文字）による検索
  - 出願人名による検索
  
- **第2段階（実用的検索）**
  - 称呼（カタカナ）による検索
  - 登録番号による検索
  - ステータス（最終処分）による検索
  - 日付範囲検索

- **第3段階（高度な検索）**
  - 類似群コードによる検索
  - 商品・役務名による検索
  - 複合条件検索（AND/OR）

### 2. 設計フェーズ

#### CLIインターフェース
```
=== TMCloud 商標検索システム ===
1: 出願番号で検索
2: 商標名で検索
3: 出願人で検索
0: 終了
```

#### 表示形式
```
出願番号      商標        出願人              区分
------------ ---------- ------------------ ------
2023123456   コカコーラ   コカ・コーラ(株)    32,33
```

#### データベース構造の確認
- **総レコード数**: 2,298,845件
- **主要テーブル**:
  - trademark_case_info: 54,495件
  - trademark_search: 174,587件（検索用商標）
  - trademark_standard_char: 63,014件（標準文字商標）
  - trademark_applicants_agents: 120,249件
  - applicant_registration_info: 6,711件（出願人マスタ）
  - trademark_goods_services: 108,817件

### 3. 実装フェーズ

#### 検索処理フロー
1. **該当レコードの特定**
   - 出願番号 → trademark_case_info
   - 商標名 → trademark_search/trademark_standard_char/trademark_display
   - 出願人 → applicant_registration_info + trademark_applicants_agents

2. **関連情報の収集**
   - 各テーブルから必要な情報をJOINで結合
   - GROUP_CONCATで複数データを集約

#### SQLクエリ設計の特徴
- 商標名は3テーブル（search/standard_char/display）をUNIONで統合検索
- 出願人は全員表示（GROUP_CONCAT）
- 出願人名が取得できない場合は「申請人コード:XXXXXXXXX」表示
- 区分は昇順でカンマ区切り表示

### 4. テスト結果

#### 動作確認済み
- ✓ 出願番号検索: 2024036231 → 正常動作
- ✓ 商標名検索: ごきげんショコラ → 正常動作
- ✓ 出願人検索: 株式会社ＲＥＮＯＴＩＯＮ → 正常動作

#### 発見された課題

##### 1. 出願人名の表示問題
- **現象**: 98%の出願人が「申請人コード:XXXXXXXXX」と表示される
- **原因**: applicant_registration_infoテーブルのマスタデータ不足
- **統計**: 
  - 出願人総数: 55,155件
  - 名前が取得できる: 1,151件（2%）

##### 2. 古い商標の検索不可
- **現象**: 一部の商標（例：ＲＩＭＡＳＴＥＲ/1997102833）が検索できない
- **原因**: trademark_case_infoテーブルに該当レコードが存在しない
- **詳細**: trademark_standard_charには存在するが、case_infoには存在しない

##### 3. 文字エンコーディング
- **確認事項**: 全角/半角、特殊文字（®、™など）の扱い
- **現状**: 基本的な日本語・英数字は問題なく表示

### 5. ファイル構成

#### 作成したファイル
- `tmcloud_search.py` - メイン検索スクリプト
- `test_search.py` - テスト用スクリプト
- `debug_search.py` - デバッグ用スクリプト

#### 削除予定のファイル
- test_search.py（テスト完了後）
- debug_search.py（デバッグ完了後）

### 6. 今後の改善点

#### 短期的改善
1. 出願人マスタデータの補完
2. trademark_case_infoに存在しない商標の処理方法検討
3. エラーメッセージの充実

#### 中期的改善（第2段階）
1. 称呼検索の実装
2. 日付範囲検索の実装
3. ページネーション機能

#### 長期的改善（第3段階）
1. 複合条件検索
2. Webインターフェース
3. 検索結果のエクスポート機能

### 7. 使用方法

```bash
# 基本的な使用
python3 tmcloud_search.py

# データベース指定
python3 tmcloud_search.py tmcloud_v2_20250807_213449.db

# テスト実行例
echo -e "1\n2024036231\n0" | python3 tmcloud_search.py
```

### 8. 技術的メモ

#### パフォーマンス
- 単一条件検索: 実測1秒以内
- 検索結果表示: 最大20件に制限

#### SQLite特有の注意点
- GROUP_CONCATの使用
- COALESCE関数での NULL処理
- PRAGMA foreign_keys=ON は不要（検索のみのため）

## まとめ

第1段階の基本検索機能は正常に動作することを確認。ただし、出願人マスタデータの不足により、実用レベルには追加のデータ整備が必要。検索スクリプト自体は、実際のデータベース構造に基づいて正確に実装されており、今後の拡張の基盤として十分な品質を確保できた。