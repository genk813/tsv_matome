# TMCloud 週次更新システム作業履歴

## 2025-08-04 作業記録

### 実施内容

#### 1. 週次更新スクリプトのテスト
- **tmcloud_weekly_update.py** (v15) の動作確認
- 20250625 → 20250702 → 20250709 → 20250716 の週次更新テストを実施
- すべてのテストで正常にUPSERT動作（挿入/更新）することを確認

#### 2. 週次TSVデータの分析
- 各週のデータには60-70%の重複（既存出願のステータス更新）があることを判明
- 週次ファイルには新規出願と既存出願の更新が混在
- 更新が多く、挿入が少ないのは正常な動作

#### 3. フォルダ整理
削除したファイル:
- 更新統計JSONファイル（23個）
- テスト用データベース（6個）
- Zone.Identifierファイル（多数）
- 古いバックアップスクリプト（3個）
- 一時テストスクリプト（4個）
- 古いデータベースバックアップ

#### 4. データベース再作成
- 誤って削除したメインデータベースを再作成
- `tmcloud_v2_20250804_215722.db` (393MB) を20250611データから作成
- 全テーブルに正常にデータをインポート

#### 5. TSVファイル構造の統一
- 20250618と20250625のサブフォルダ構造をフラット化
- すべての週次データを「日付フォルダ/TSVファイル」の統一構造に変更
- 各週のファイル数: 82〜98個

### 現在のシステム状態

#### メインファイル
- **tmcloud_weekly_update.py** - 週次更新スクリプト（動作確認済み）
- **tmcloud_import_v2.py** - 初期インポート用
- **tmcloud_schema_v2.sql** - データベーススキーマ
- **tmcloud_v2_20250804_215722.db** - メインデータベース（393MB）

#### TSVデータ構造
```
tsv_data/tsv/
├── 20250611/  (82 TSVファイル)
├── 20250618/  (93 TSVファイル)  
├── 20250625/  (89 TSVファイル)
├── 20250702/  (92 TSVファイル)
├── 20250709/  (94 TSVファイル)
└── 20250716/  (98 TSVファイル)
```

### 週次更新の動作確認結果
- UPSERT機能は正常に動作
- 既存レコードは更新、新規レコードは挿入
- エラー0件で安定動作

## 次のステップ
1. 実運用での週次更新プロセスの確立
2. 自動化スクリプトの作成（必要に応じて）
3. バックアップとリカバリ手順の文書化