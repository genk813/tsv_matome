# テーブル検証手順書

## 基本原則
**特許庁CSV仕様書が唯一の真実**
- 推測・憶測は一切禁止
- 仕様書が見つからない場合は、諦めずに徹底的に探す
- カラム名は仕様書の物理名と完全一致させる

## 検証手順

### 1. 特許庁CSV仕様書の特定
1. テーブルに対応するTSVファイル名を確認
2. `/home/ygenk/TMCloud/old_files/csvs/`内で対応する仕様書を検索
   - ファイル名で検索
   - 物理ファイル名で検索
   - カラム名で検索
3. **見つからない場合は諦めるな！**必ず存在する

### 2. 仕様書の読み取り
1. ファイル名（物理名）を確認
2. 主キー（○印のついたカラム）を確認
3. 全カラムの物理名を確認
4. データ型と桁数を確認

### 3. スクリプトの検証
#### 週次更新スクリプト（tmcloud_weekly_update_v17.py）
- key_columnsが主キーと一致しているか
- column_mappingが全カラムを網羅しているか
- TSVファイルのカラム名（左）→DBカラム名（右）のマッピングが正しいか

#### インポートスクリプト（tmcloud_import_v2.py）
- 同様に全カラムが正しくマッピングされているか確認

#### SQLスキーマ（tmcloud_schema_v2.sql）
- PRIMARY KEYが仕様書と一致しているか
- カラム定義が正しいか

## これまでの体たらく記録

### テーブル11: trademark_right_goods
- **失態**: CSV仕様書を探さずに諦めて「見つからない」と報告
- **実際**: 127_本権商品名ファイル.csv が存在していた
- **教訓**: 諦めるな。必ず仕様書は存在する

### 誤ったカラムマッピングの例
1. **trademark_case_info**: 49カラム中21カラムが欠落していた
2. **trademark_applicants_agents**: 存在しないカラム（shutugannindairinin_kojinhoujin）をマッピング
3. **日本語ローマ字の誤字**: sikbt→sikibetu、shurui→shubetu など

### 推測による誤り
- pe_num、mu_num などを勝手に主キーに含めていた
- カラム名を推測で決めていた（例: tokkyo_toroku_no）

## 作業記録フォーマット
```
## テーブルX: テーブル名

### 特許庁CSV仕様書（ファイル番号_ファイル名.csv）
ファイル名: xxx.tsv
主キー: カラム1 + カラム2 + ...

全Xカラム:
1. 物理名 - 論理名 ○主キー
2. ...

### 検証結果
- 週次更新スクリプト: X個のカラムが欠落/誤り
- インポートスクリプト: X個のカラムが欠落/誤り
- SQLスキーマ: 問題なし/問題あり

### 修正内容
（具体的な修正内容を記載）
```

## 作業履歴

### 2025-08-07 全40テーブル検証完了

#### 実施内容
1. 全40テーブルについて、特許庁CSV仕様書との整合性を検証
2. 週次更新スクリプト、インポートスクリプト、SQLスキーマの3ファイルを比較検証
3. 大量のカラムマッピング誤りと PRIMARY KEY 定義の不整合を修正

#### 主な修正箇所
- テーブル1-4: カラム名修正（dt → date など）
- テーブル13-15: 大量のカラムマッピング修正（40カラム以上）
- テーブル29-30: 全カラム名の修正が必要だった
- テーブル32-36: 国際商標関連で PRIMARY KEY 定義が不完全
- テーブル35: madpro_class → madopro_class の誤字修正
- テーブル37: インポートスクリプトのカラム名修正（sytgn_bngu → app_num）
- テーブル38-39: 防護標章関連で大量のカラムマッピング修正

#### 体たらく記録（追加）
- テーブル35で madpro_class の誤字を見逃しそうになった
- PRIMARY KEY の定義で多くのカラムが欠落していたことを発見
- 防護標章関連テーブルで、CSV仕様と全く異なるカラム名を使用していた

#### 結果
- 全40テーブルの検証・修正完了
- 特許庁CSV仕様書との完全な整合性を確保