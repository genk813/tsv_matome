# TMCloud 週次更新システム作業履歴

## 2025-08-05 作業記録

### 実施内容

#### 削除系ファイル対応（v16）
- **tmcloud_weekly_update.py** を v16 に更新
- 削除系ファイル（del_*.tsv）の処理ロジックを実装
  - `del_snpn_zkn.tsv`: 審判番号による審判事件の削除
  - `del_t_basic_item_art.tsv`: 出願番号による商標関連データの削除
- 削除対象テーブルを12テーブルに拡張
- 削除前のデータ存在確認を追加
- 削除処理の詳細ログ出力を追加

#### 削除処理の動作確認
- 20250611のデータで削除処理をテスト
- 削除結果：
  - 出願番号 2017114531, 2020145693 の2件を削除
  - 合計80件のレコードを12テーブルから削除
  - 各テーブルの削除件数を詳細にログ出力

### 削除系ファイルの分析結果
- 削除ファイルは週次データに含まれたり含まれなかったりする
- 含まれる週: 20250611, 20250618, 20250709, 20250716
- 含まれない週: 20250625, 20250702
- ファイル構造は同一、削除対象のキー（審判番号/出願番号）のみ異なる

## 2025-08-04 作業記録

### 実施内容

#### 1. 週次更新スクリプトのテスト
- **tmcloud_weekly_update.py** (v15) の動作確認
- 20250625 → 20250702 → 20250709 → 20250716 の週次更新テストを実施
- すべてのテストで正常にUPSERT動作（挿入/更新）することを確認

#### 2. 週次TSVデータの分析
- 各週のデータには60-70%の重複（既存出願のステータス更新）があることを判明
- 週次ファイルには新規出願と既存出願の更新が混在
- 更新が多く、挿入が少ないのは正常な動作

#### 3. フォルダ整理
削除したファイル:
- 更新統計JSONファイル（23個）
- テスト用データベース（6個）
- Zone.Identifierファイル（多数）
- 古いバックアップスクリプト（3個）
- 一時テストスクリプト（4個）
- 古いデータベースバックアップ

#### 4. データベース再作成
- 誤って削除したメインデータベースを再作成
- `tmcloud_v2_20250804_215722.db` (393MB) を20250611データから作成
- 全テーブルに正常にデータをインポート

#### 5. TSVファイル構造の統一
- 20250618と20250625のサブフォルダ構造をフラット化
- すべての週次データを「日付フォルダ/TSVファイル」の統一構造に変更
- 各週のファイル数: 82〜98個

### 現在のシステム状態

#### メインファイル
- **tmcloud_weekly_update.py** - 週次更新スクリプト（v16、削除対応済み）
- **tmcloud_import_v2.py** - 初期インポート用
- **tmcloud_schema_v2.sql** - データベーススキーマ
- **tmcloud_v2_20250804_215722.db** - メインデータベース（393MB）

#### TSVデータ構造
```
tsv_data/tsv/
├── 20250611/  (82 TSVファイル、del_あり)
├── 20250618/  (93 TSVファイル、del_あり)  
├── 20250625/  (89 TSVファイル、del_なし)
├── 20250702/  (92 TSVファイル、del_なし)
├── 20250709/  (94 TSVファイル、del_あり)
└── 20250716/  (98 TSVファイル、del_あり)
```

### 更新履歴

#### v16 (2025-08-05) - 最新版
- 削除系ファイル（del_*.tsv）の処理を実装
- 削除対象テーブルを12テーブルに拡張
- 削除前のデータ存在確認とエラーハンドリングを追加

#### v15 (2025-08-04)
- TSVファイルのディレクトリ構造を統一化
- 重複ファイルの処理を修正

#### v12 (2025-08-02)
- 全テーブルのPRIMARY KEY修正
- エラー0件を達成